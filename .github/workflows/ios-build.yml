name: iOS Build

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Checkout submodules (retry)
        run: |
          set -euo pipefail
          git submodule sync --recursive
          for attempt in 1 2 3 4 5; do
            if git -c protocol.version=2 submodule update --init --force --depth=1 --recursive; then
              exit 0
            fi
            echo "Submodule update failed (attempt $attempt/5). Retryingâ€¦"
            sleep $((attempt * 10))
          done
          exit 1

      - name: Select Xcode 26.1
        run: |
          sudo xcode-select -s /Applications/Xcode_26.1.app
          xcodebuild -version

      - name: Install dependencies
        run: |
          brew install xcodegen swiftlint swiftformat fastlane

      - name: Show toolchain
        run: |
          sw_vers
          xcodebuild -version
          swift --version
          fastlane --version

      - name: Generate iOS project
        run: |
          cd apps/ios
          xcodegen generate

      - name: Build iOS app
        run: |
          cd apps/ios
          set -euo pipefail

          # Get team ID
          TEAM_ID="${IOS_DEVELOPMENT_TEAM:-}"
          if [ -z "$TEAM_ID" ]; then
            TEAM_ID=$(bash ../../scripts/ios-team-id.sh 2>/dev/null || echo "")
          fi

          if [ -z "$TEAM_ID" ]; then
            echo "Warning: Could not determine team ID, using automatic signing"
            SIGNING_ARGS="-allowProvisioningUpdates"
          else
            echo "Using team ID: $TEAM_ID"
            SIGNING_ARGS="DEVELOPMENT_TEAM=$TEAM_ID -allowProvisioningUpdates"
          fi

          # Build for testing (ad-hoc distribution)
          xcodebuild archive \
            -project OpenClaw.xcodeproj \
            -scheme OpenClaw \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/OpenClaw.xcarchive" \
            -destination "generic/platform=iOS" \
            $SIGNING_ARGS \
            CODE_SIGN_STYLE=Automatic \
            CODE_SIGN_IDENTITY="Apple Development"

          # Export IPA
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/OpenClaw.xcarchive" \
            -exportPath "$RUNNER_TEMP/export" \
            -exportOptionsPlist <(cat <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>development</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF
          ) \
            $SIGNING_ARGS

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenClaw-iOS
          path: ${{ runner.temp }}/export/*.ipa
          retention-days: 30
          if-no-files-found: error

      - name: Build info
        run: |
          echo "Build completed successfully"
          ls -lh "$RUNNER_TEMP/export/"
          if [ -f "$RUNNER_TEMP/export/OpenClaw.ipa" ]; then
            echo "IPA size: $(du -h "$RUNNER_TEMP/export/OpenClaw.ipa" | cut -f1)"
          fi
